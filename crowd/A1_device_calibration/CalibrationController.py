from CalibrationService import *


class CalibrationController:
    calibrationService = CalibrationService(CalibrationServerConfig(data_dir='../Data/'))
    batchOutputPath = '../Data/crowd_targets_raw_calibrated.txt'

    def __init__(self):
        return

    '''
    input:
    area_id = current area id (integer)
    device_model = string of device model
    fingerprint = bssid1_rssi1__bssid2_rssi2__...__bssidn_rssin
    fingerprints = bssid11_rssi11__bssid12_rssi12__...bssid1n_rssi1n___...___bssidn1_rssin1__...__bssidnn_rssinn

    output:
    if neither fingerprint nor fingerprints is provided, output = needCalibrate_offset
    if fingerprint is provided, output = string of signature with p_all.txt format
    if fingerprints is provided, output = location of calibrated signature file
    '''
    def calibrateOffset(self, area_id, device_model, fingerprint=None, fingerprints=None):
        if fingerprints is not None:
            cfString = self.calibrationService.computeCalibrationFactorGivenTargetsRaw(area_id, device_model, fingerprints)
        elif fingerprint is not None:
            cfString = self.calibrationService.computeCalibrationFactorGivenTargetRaw(area_id, device_model, fingerprint)
        else:
            cfString = self.calibrationService.getCalibrationFactorRaw(area_id, device_model)
        print (cfString)
        needCalibration = cfString.split('_')[0] == 'True'
        offset = float(cfString.split('_')[1]) if needCalibration else 0.0
        if fingerprint is not None:
            listOfBssid2Rssi = fingerprint.split('__')
            cfString = CalibrationController.formatCalibratedSignature(listOfBssid2Rssi, offset)
        elif fingerprints is not None:
            if os.path.isfile(CalibrationController.batchOutputPath):
                os.remove(CalibrationController.batchOutputPath)
            f = open(CalibrationController.batchOutputPath, 'w+')
            for listOfBssid2Rssi in fingerprints.split('___'):
                listOfBssid2Rssi = listOfBssid2Rssi.split('__')
                f.write(CalibrationController.formatCalibratedSignature(listOfBssid2Rssi, offset)+'\n')
            f.close()
            cfString = CalibrationController.batchOutputPath
        return cfString

    def calibrateOffsetFromPall(self, filepath):
        f = open(filepath, 'r+')
        signatures = []
        for line in f.readlines():
            line = line.replace('\n', '').replace('\r', '')
            if len(line) == 0:
                continue
            line = line.split(' ')
            signature = []
            for column in line:
                column = column.replace(':', ',').split(',')
                if len(column) < 3:
                    continue
                bssid = column[0]
                rssi = column[1]
                signature.append(bssid+'_'+rssi)
            signatures.append('__'.join(signature))
        f.close()
        print (self.calibrateOffset(area_id=1003, device_model=filepath.split('.')[0], fingerprints='___'.join(signatures)))

    @staticmethod
    def formatCalibratedSignature(listOfBssid2Rssi, offset):
        calibrated = []
        for bssid2Rssi in listOfBssid2Rssi:
            bssid2Rssi = bssid2Rssi.split('_')
            bssid = bssid2Rssi[0]
            rssi = float(bssid2Rssi[1])+offset
            calibrated.append(bssid+':'+str(rssi)+',0,0')
        return ' '.join(calibrated)

controller = CalibrationController()

controller.calibrateOffsetFromPall('../Data/crowd_targets_raw.txt')

# # demo: multiple signatures
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprints='F40F1B97F989_-85.0__84B802C968F9_-53.0__F40F1B97F982_-79.0__F40F1B97F983_-72.0__84B802C968F6_-52.0__F40F1B97F981_-72.0__84B802C968F1_-62.0__F40F1B97F984_-73.0__F40F1B97F985_-73.0__84B802C968F5_-62.0__F40F1B93A4F1_-55.0__F40F1B93A4F2_-54.0__F40F1B93A4F3_-61.0__F40F1B93A4F4_-54.0__F40F1B93A4F5_-55.0__F40F1B93A4F9_-65.0__84B8029E819A_-74.0__84B8029E819B_-73.0__84B8029E819C_-73.0__84B8029E819D_-73.0__84B8029E819E_-73.0__0C84DCA4B40C_-88.0__84B8029E8199_-74.0__80E01D206235_-75.0__84B8029E8191_-73.0__F40F1B97F98B_-84.0__84B8029E8194_-73.0__84B8029E8195_-73.0__84B8029E8196_-73.0__80E01D206236_-76.0__84B802C968F4_-63.0__80E01D206234_-85.0__6466B32F020A_-88.0__80E01D206232_-75.0__80E01D206231_-76.0__F40F1B93A4FA_-65.0__F40F1B93A4FB_-64.0__F40F1B93A4FC_-65.0__F40F1B93A4FD_-65.0__F40F1B93A4FE_-65.0__84B802C968FE_-54.0__84B802C968F3_-62.0__84B802C968FC_-54.0__7824AFED22B0_-88.0__D8B190DC5AF1_-79.0__84B802C968FB_-53.0__D8B190DC5AF5_-80.0__84B802C968FD_-53.0__F40F1B97F98C_-84.0__F40F1B97F98A_-85.0__84B802C968FA_-54.0__F40F1B97F98D_-84.0__F40F1B97F98E_-84.0___F40F1B97F989_-85.0__84B802C968F9_-53.0__F40F1B97F982_-79.0__F40F1B97F983_-72.0__84B802C968F6_-52.0__F40F1B97F981_-72.0__84B802C968F1_-62.0__F40F1B97F984_-73.0__F40F1B97F985_-73.0__84B802C968F5_-62.0__F40F1B93A4F1_-55.0__F40F1B93A4F2_-54.0__F40F1B93A4F3_-61.0__F40F1B93A4F4_-54.0__F40F1B93A4F5_-55.0__F40F1B93A4F9_-65.0__84B8029E819A_-74.0__84B8029E819B_-73.0__84B8029E819C_-73.0__84B8029E819D_-73.0__84B8029E819E_-73.0__0C84DCA4B40C_-88.0__84B8029E8199_-74.0__80E01D206235_-75.0__84B8029E8191_-73.0__F40F1B97F98B_-84.0__84B8029E8194_-73.0__84B8029E8195_-73.0__84B8029E8196_-73.0__80E01D206236_-76.0__84B802C968F4_-63.0__80E01D206234_-85.0__6466B32F020A_-88.0__80E01D206232_-75.0__80E01D206231_-76.0__F40F1B93A4FA_-65.0__F40F1B93A4FB_-64.0__F40F1B93A4FC_-65.0__F40F1B93A4FD_-65.0__F40F1B93A4FE_-65.0__84B802C968FE_-54.0__84B802C968F3_-62.0__84B802C968FC_-54.0__7824AFED22B0_-88.0__D8B190DC5AF1_-79.0__84B802C968FB_-53.0__D8B190DC5AF5_-80.0__84B802C968FD_-53.0__F40F1B97F98C_-84.0__F40F1B97F98A_-85.0__84B802C968FA_-54.0__F40F1B97F98D_-84.0__F40F1B97F98E_-84.0')
#
# # demo: single signature
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprint='F40F1B97F989_-85.0__84B802C968F9_-48.0__84B802C968F4_-59.0__84B802C968F5_-59.0__84B802C968F6_-75.0__F40F1B97F981_-73.0__84B802C968F1_-60.0__F40F1B97F984_-73.0__F40F1B97F985_-72.0__F40F1B93A4F1_-55.0__F40F1B93A4F2_-54.0__F40F1B93A4F3_-55.0__F40F1B93A4F4_-55.0__F40F1B93A4F5_-55.0__F40F1B93A4F9_-67.0__84B8029E819A_-73.0__84B8029E819B_-71.0__84B8029E819C_-72.0__84B8029E819D_-71.0__84B8029E819E_-72.0__0C84DCA4B40C_-82.0__84B8029E8199_-72.0__F40F1B97F98B_-84.0__D8B190DC5AF6_-80.0__84B8029E8191_-76.0__84B8029E8192_-78.0__84B8029E8194_-76.0__84B8029E8195_-76.0__84B8029E8196_-77.0__80E01D206236_-75.0__80E01D206235_-75.0__80E01D206234_-75.0__6466B32F020A_-88.0__80E01D206232_-76.0__80E01D206231_-76.0__F40F1B93A4FA_-67.0__F40F1B93A4FB_-67.0__F40F1B93A4FC_-67.0__F40F1B93A4FD_-67.0__F40F1B93A4FE_-67.0__84B802C968FE_-49.0__84B802C968F3_-60.0__84B802C968FC_-48.0__80E01D206233_-76.0__7824AFED22B0_-85.0__D8B190DC5AF3_-80.0__D8B190DC5AF2_-80.0__D8B190DC5AF1_-80.0__84B802C968FB_-48.0__D8B190DC5AF5_-79.0__D8B190DC5AF4_-80.0__84B802C968FD_-48.0__F40F1B97F98C_-85.0__F40F1B97F98A_-85.0__84B802C968FA_-49.0__F40F1B97F98D_-85.0__F40F1B97F98E_-85.0')
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprint='F40F1B97F989_-69.0__F40F1B97E2BF_-76.0__84B802C968F9_-52.0__F40F1B97E2BD_-77.0__84B802C968F4_-54.0__F40F1B97F983_-64.0__84B802C968F6_-55.0__F40F1B97F981_-63.0__84B802C968F1_-54.0__F40F1B97F984_-64.0__F40F1B97F985_-63.0__F40F1B97F98B_-69.0__0023EB3A0E2E_-84.0__F40F1B93A4F1_-42.0__F40F1B93A4F2_-55.0__F40F1B93A4F3_-43.0__F40F1B93A4F4_-43.0__F40F1B93A4F5_-42.0__84B802C968F2_-55.0__F40F1B93A4F9_-50.0__84B8029E819A_-71.0__84B8029E819B_-71.0__84B8029E819C_-71.0__84B8029E819D_-72.0__84B8029E819E_-72.0__0C84DCA4B40C_-64.0__84B802C968F5_-54.0__80E01D206235_-69.0__D8B190DC5AF6_-87.0__84B8029E8191_-68.0__F40F1B9393CF_-87.0__84B8029E8193_-78.0__84B8029E8194_-65.0__84B8029E8195_-65.0__84B8029E8199_-72.0__F40F1B93A4FE_-50.0__80E01D206234_-68.0__6466B32F020A_-88.0__80E01D206231_-68.0__F40F1B93A4FA_-50.0__F40F1B93A4FB_-50.0__84B802C95743_-82.0__F40F1B93A4FD_-50.0__84B802C95745_-81.0__84B802C968FE_-52.0__0023EB2CDFB1_-80.0__84B802C968FC_-52.0__80E01D206233_-76.0__7824AFED22B0_-85.0__D8B190DC5AF3_-80.0__D8B190DC5AF2_-88.0__D8B190DC5AF1_-80.0__F40F1B93A4FC_-50.0__00F76FD1B1C2_-76.0__84B802C968FB_-52.0__D8B190DC5AF4_-80.0__84B802C968FD_-47.0__F40F1B97F98C_-69.0__F40F1B97F98A_-69.0__84B802C968FA_-52.0__F40F1B97F98D_-69.0__F40F1B97F98E_-69.0')
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprint='F40F1B97F989_-74.0__F40F1B97E2BF_-76.0__84B802C968F9_-58.0__F40F1B97E2BD_-77.0__F40F1B97F982_-69.0__F40F1B97F983_-64.0__84B802C968F6_-61.0__F40F1B97F981_-65.0__84B802C968F1_-62.0__F40F1B97F984_-64.0__F40F1B97F985_-65.0__84B802C968F5_-59.0__F40F1B97F98B_-74.0__0023EB3A0E2E_-84.0__F40F1B93A4F1_-44.0__F40F1B93A4F2_-57.0__F40F1B93A4F3_-43.0__F40F1B93A4F4_-44.0__F40F1B93A4F5_-45.0__84B802C968F2_-63.0__0023EB2CDFBE_-71.0__F40F1B93A4F9_-55.0__64EB8CD01336_-88.0__84B8029E819A_-68.0__84B8029E819B_-68.0__84B8029E819C_-68.0__F40F1B9393C0_-87.0__84B8029E819E_-68.0__F40F1B9393C2_-85.0__84B8029E8199_-68.0__84B8029E819D_-68.0__80E01D206235_-78.0__D8B190DC5AF6_-87.0__F40F1B9393CD_-79.0__84B8029E8191_-59.0__84B8029E8192_-74.0__84B8029E8193_-74.0__84B8029E8194_-59.0__84B8029E8195_-59.0__84B8029E8196_-74.0__02E04C76FF51_-88.0__F40F1B9393CF_-79.0__80E01D206236_-79.0__F40F1B93A4FE_-55.0__80E01D206234_-77.0__6466B32F020A_-88.0__80E01D206231_-68.0__F40F1B93839F_-88.0__F40F1B93A4FB_-55.0__84B802C95743_-82.0__F40F1B93A4FD_-55.0__84B802C95745_-81.0__84B802C968FE_-58.0__84B802C968F3_-58.0__0023EB2CDFB1_-80.0__F40F1B93A4FA_-55.0__84B802C968FC_-58.0__0C84DCA4B40C_-64.0__0023EB3A12D1_-70.0__7824AFED22B0_-79.0__D8B190DC5AF2_-88.0__84B802C968F4_-62.0__F40F1B93A4FC_-55.0__00F76FD1B1C2_-85.0__84B802C968FB_-58.0__84B802C968FD_-52.0__F40F1B97F98C_-74.0__F40F1B97F98A_-74.0__84B802C968FA_-58.0__F40F1B97F98D_-74.0__F40F1B97F98E_-74.0')
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprint='F40F1B97F989_-77.0__F40F1B97E2BF_-78.0__84B802C968F9_-56.0__F40F1B97F982_-82.0__F40F1B97F983_-64.0__84B802C968F6_-63.0__F40F1B97F981_-67.0__F40F1B97F986_-81.0__84B802C968F1_-62.0__F40F1B97F984_-68.0__F40F1B97F985_-67.0__84B802C968F5_-62.0__F40F1B93A4F1_-44.0__F40F1B93A4F2_-62.0__F40F1B93A4F4_-48.0__F40F1B93A4F5_-63.0__F40F1B93A4F6_-61.0__F40F1B93839D_-86.0__0023EB2CDFBE_-71.0__F40F1B93A4F9_-56.0__64EB8CD01336_-79.0__84B8029E819A_-64.0__84B8029E819B_-64.0__84B8029E819C_-65.0__F40F1B9393C0_-71.0__84B8029E819E_-64.0__F40F1B9393C2_-70.0__84B8029E8199_-65.0__84B8029E819D_-65.0__F40F1B97F98B_-77.0__F40F1B9393CD_-79.0__84B8029E8191_-55.0__84B8029E8192_-70.0__84B8029E8193_-74.0__84B8029E8194_-55.0__84B8029E8195_-55.0__84B8029E8196_-55.0__02E04C76FF51_-88.0__F40F1B9393CF_-80.0__80E01D206236_-79.0__80E01D206235_-78.0__80E01D206234_-77.0__84B802C968F2_-63.0__F40F1B93839F_-88.0__F40F1B93A4FB_-56.0__F40F1B93A4FC_-56.0__F40F1B93A4FD_-56.0__F40F1B93A4FE_-56.0__84B802C968FE_-56.0__84B802C968F3_-58.0__F40F1B93A4FA_-56.0__84B802C968FC_-56.0__0C84DCA4B40C_-64.0__0023EB3A12D1_-70.0__7824AFED22B0_-85.0__84B802C968F4_-64.0__00F76FD1B1C2_-85.0__84B802C968FB_-56.0__D8B190DC5AF4_-70.0__84B802C968FD_-55.0__F40F1B97F98C_-77.0__F40F1B97F98A_-77.0__84B802C968FA_-56.0__F40F1B97F98D_-77.0__F40F1B97F98E_-76.0')
# print controller.calibrateOffset(area_id=1002, device_model='S4', fingerprint='F40F1B97F989_-69.0__F40F1B97E2BF_-74.0__84B802C968F9_-58.0__F40F1B97E2BD_-73.0__F40F1B97F982_-59.0__F40F1B97F983_-75.0__84B802C968F6_-77.0__F40F1B97F986_-76.0__84B802C968F1_-63.0__F40F1B97F984_-59.0__84B802C968F3_-77.0__84B802C968F5_-63.0__586D8FA5E62D_-88.0__0023EB3A0E2E_-88.0__F40F1B93A4F1_-58.0__F40F1B93A4F2_-58.0__F40F1B93A4F3_-67.0__F40F1B93A4F4_-68.0__F40F1B93A4F5_-58.0__F40F1B93A4F6_-68.0__F40F1B93839D_-82.0__F40F1B93A4F9_-70.0__64EB8CD01336_-88.0__98FC11FC224E_-87.0__98FC11FC224F_-85.0__84B8029E819A_-59.0__84B8029E819B_-58.0__84B8029E819C_-58.0__F40F1B9393C0_-86.0__84B8029E819E_-58.0__F40F1B9393C2_-71.0__84B8029E8199_-58.0__84B8029E819D_-59.0__F40F1B97F98B_-69.0__84B8029E8191_-48.0__84B8029E8192_-77.0__84B8029E8193_-48.0__84B8029E8194_-48.0__84B8029E8195_-48.0__84B8029E8196_-49.0__F40F1B938392_-89.0__F40F1B9393CF_-73.0__80E01D206236_-87.0__80E01D206235_-73.0__80E01D206234_-72.0__80E01D206233_-82.0__80E01D206232_-87.0__80E01D206231_-68.0__0023EB39FA7E_-85.0__F40F1B93839F_-78.0__F40F1B93A4FB_-70.0__F40F1B93A4FC_-70.0__F40F1B93A4FD_-70.0__F40F1B93A4FE_-70.0__84B802C968FE_-58.0__F40F1B97F985_-59.0__F40F1B93A4FA_-70.0__84B802C968FC_-58.0__28C68EDD24FD_-88.0__0C84DCA4B40C_-88.0__7824AFED22B4_-82.0__48F8B3F21F0C_-85.0__7824AFED22B0_-82.0__D8B190DC5AF3_-87.0__84B802C968F4_-63.0__84B802C968FB_-58.0__D8B190DC5AF4_-83.0__84B802C968FD_-57.0__F40F1B97F98C_-69.0__F40F1B97F98A_-69.0__84B802C968FA_-59.0__F40F1B97F98D_-69.0__F40F1B97F98E_-69.0')